<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh-Chain ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ (ì‹¤ì œ ë°ì´í„°)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #ff0000;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .highway-view {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .highway {
            width: 100%;
            height: 100%;
            background: #2a2a3e;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .lane {
            position: absolute;
            width: 100%;
            height: 45%;
            border-bottom: 2px dashed #555;
        }

        .lane:first-child {
            top: 5%;
        }

        .lane:last-child {
            top: 50%;
        }

        .vehicle {
            position: absolute;
            width: 40px;
            height: 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .sidebar {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .stat-card {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0f3460;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            transition: width 0.3s ease;
        }

        .log-panel {
            grid-column: 1 / -1;
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #0f3460;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: #888;
        }

        .log-success {
            color: #43e97b;
        }

        .log-info {
            color: #00d9ff;
        }

        .log-error {
            color: #f5576c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                ğŸš— Mesh-Chain ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ë°ì´í„°)
            </h1>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span id="sim-time">ì‹œê°„: 0.0s</span>
                </div>
            </div>
        </div>

        <div class="highway-view">
            <h2 style="margin-bottom: 15px;">ê³ ì†ë„ë¡œ ë·° (1000m Ã— 2 lanes)</h2>
            <div class="highway" id="highway">
                <div class="lane"></div>
                <div class="lane"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="stat-card">
                <h3>í™œì„± ì°¨ëŸ‰</h3>
                <div class="stat-value" id="active-vehicles">0</div>
                <div class="stat-label">ì´ ì°¨ëŸ‰ ìˆ˜</div>
            </div>

            <div class="stat-card">
                <h3>ìƒì„±ëœ ë¸”ë¡</h3>
                <div class="stat-value" id="blocks-created">0</div>
                <div class="stat-label">ì„±ê³µ / ì‹¤íŒ¨: <span id="block-ratio">0/0</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="success-rate" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-card">
                <h3>WAVE í†µì‹ </h3>
                <div class="stat-value" id="wave-messages">0</div>
                <div class="stat-label">ì „ì†¡: <span id="wave-sent">0</span> / ìˆ˜ì‹ : <span id="wave-received">0</span></div>
                <div class="stat-label">ì†ì‹¤ë¥ : <span id="wave-loss">0%</span></div>
            </div>

            <div class="stat-card">
                <h3>libp2p ì—°ê²°</h3>
                <div class="stat-value" id="p2p-peers">0</div>
                <div class="stat-label">DHT, GossipSub, Bitswap</div>
            </div>

            <div class="stat-card">
                <h3>í‰ê·  ì§€ì—°ì‹œê°„</h3>
                <div class="stat-value" id="avg-latency">0.0ms</div>
                <div class="stat-label">ëª©í‘œ: â‰¤100ms</div>
            </div>
        </div>

        <div class="log-panel">
            <h3 style="margin-bottom: 15px;">ğŸ“‹ ì´ë²¤íŠ¸ ë¡œê·¸ (ì‹¤ì‹œê°„)</h3>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        let lastData = null;
        let lastUpdateTime = 0;

        // ë¡œê·¸ ì¶”ê°€
        function addLog(type, message) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';

            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${icon} ${message}</span>
            `;

            container.insertBefore(entry, container.firstChild);

            // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
        async function loadSimulationData() {
            try {
                const response = await fetch('data/simulation_data.json?' + Date.now());

                if (!response.ok) {
                    throw new Error('ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const data = await response.json();
                updateDashboard(data);

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                document.getElementById('status-text').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘';
                document.getElementById('status-dot').classList.remove('error');

                lastUpdateTime = Date.now();
                lastData = data;

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('status-text').textContent = 'ë°ì´í„° ì—°ê²° ëŠê¹€';
                document.getElementById('status-dot').classList.add('error');

                // 5ì´ˆ ì´ìƒ ì—…ë°ì´íŠ¸ ì—†ìœ¼ë©´ ê²½ê³ 
                if (Date.now() - lastUpdateTime > 5000) {
                    addLog('error', 'ì‹œë®¬ë ˆì´í„°ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard(data) {
            // ì‹œê°„ ì—…ë°ì´íŠ¸
            document.getElementById('sim-time').textContent = `ì‹œê°„: ${data.time.toFixed(1)}s`;

            // ì°¨ëŸ‰ í‘œì‹œ
            updateVehicles(data.vehicles);

            // í†µê³„ ì—…ë°ì´íŠ¸
            const stats = data.stats;
            document.getElementById('active-vehicles').textContent = stats.activeVehicles;
            document.getElementById('blocks-created').textContent = stats.blocksCreated;
            document.getElementById('block-ratio').textContent =
                `${stats.blocksCreated}/${stats.blocksFailed}`;

            const successRate = (stats.blocksCreated + stats.blocksFailed) > 0 ?
                (stats.blocksCreated / (stats.blocksCreated + stats.blocksFailed) * 100) : 0;
            document.getElementById('success-rate').style.width = `${successRate}%`;

            const totalWave = stats.waveSent + stats.waveReceived;
            document.getElementById('wave-messages').textContent = totalWave;
            document.getElementById('wave-sent').textContent = stats.waveSent;
            document.getElementById('wave-received').textContent = stats.waveReceived;
            document.getElementById('wave-loss').textContent = `${stats.lossRate.toFixed(1)}%`;

            document.getElementById('p2p-peers').textContent = stats.p2pPeers;
            document.getElementById('avg-latency').textContent = `${stats.avgLatency.toFixed(1)}ms`;

            // ë³€í™” ê°ì§€ ë° ë¡œê·¸
            if (lastData) {
                if (stats.blocksCreated > lastData.stats.blocksCreated) {
                    addLog('success', `ë¸”ë¡ ìƒì„± ì„±ê³µ! ì´ ${stats.blocksCreated}ê°œ`);
                }
                if (stats.blocksFailed > lastData.stats.blocksFailed) {
                    addLog('error', `ë¸”ë¡ ìƒì„± ì‹¤íŒ¨ (ToF ê²€ì¦ ë¶€ì¡±)`);
                }
            }
        }

        // ì°¨ëŸ‰ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateVehicles(vehicles) {
            const highway = document.getElementById('highway');
            const highwayWidth = highway.clientWidth;
            const highwayLength = 1000; // meters

            // ê¸°ì¡´ ì°¨ëŸ‰ ìš”ì†Œ ì œê±°
            const existingVehicles = highway.querySelectorAll('.vehicle');
            const existingIds = new Set(Array.from(existingVehicles).map(v => v.id));
            const currentIds = new Set(vehicles.map(v => `vehicle-${v.id}`));

            // ì‚¬ë¼ì§„ ì°¨ëŸ‰ ì œê±°
            existingVehicles.forEach(elem => {
                if (!currentIds.has(elem.id)) {
                    elem.remove();
                }
            });

            // ì°¨ëŸ‰ ì—…ë°ì´íŠ¸/ìƒì„±
            vehicles.forEach(vehicle => {
                let elem = document.getElementById(`vehicle-${vehicle.id}`);

                if (!elem) {
                    elem = document.createElement('div');
                    elem.id = `vehicle-${vehicle.id}`;
                    elem.className = 'vehicle';
                    elem.textContent = vehicle.id;
                    elem.title = `${vehicle.id}\nì†ë„: ${vehicle.speed.toFixed(1)}m/s\në ˆì¸: ${vehicle.lane}`;
                    highway.appendChild(elem);

                    if (!existingIds.has(elem.id)) {
                        addLog('info', `${vehicle.id} ì§„ì…`);
                    }
                }

                // ìœ„ì¹˜ ê³„ì‚°
                const xPos = (vehicle.x / highwayLength) * highwayWidth;
                const yPos = vehicle.lane.includes('_0') ? '15%' : '60%';

                elem.style.left = `${xPos}px`;
                elem.style.top = yPos;
                elem.title = `${vehicle.id}\nì†ë„: ${vehicle.speed.toFixed(1)}m/s\nìœ„ì¹˜: ${vehicle.x.toFixed(0)}m\në ˆì¸: ${vehicle.lane}`;
            });
        }

        // ì´ˆê¸° ë¡œê·¸
        addLog('info', 'ëŒ€ì‹œë³´ë“œ ì‹œì‘ - ì‹¤ì œ ì‹œë®¬ë ˆì´í„° ë°ì´í„° ì—°ë™');
        addLog('info', 'ì‹œë®¬ë ˆì´í„°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”: ./meshchain_integrated sumo/highway.sumo.cfg 60 --sim-mode');

        // 500msë§ˆë‹¤ ë°ì´í„° ë¡œë“œ
        setInterval(loadSimulationData, 500);
    </script>
</body>
</html>
